# WimPatch 🛠️

[简体中文](README.zh.md) [English](README.md)

WimPatch 是一个高效的 Windows 映像文件 (WIM) 补丁工具，用于创建和应用 WIM 文件的增量补丁，高效且安全地管理 WIM 文件的增量更新。

## 功能特性 ✨

- **补丁创建** 📦: 比较两个 WIM 映像文件并生成增量补丁
- **补丁应用** 🚀: 将生成的补丁应用到基础映像文件，还原为更新后的映像
- **补丁合并** 🧩: 将多个增量补丁合并为一个综合补丁
- **补丁信息** ℹ️: 查看补丁文件的详细信息，支持 XML 格式输出
- **差分优化** 🧬: 支持 Zstd 和 BSDiff 两种差分算法，最大限度减小补丁包体积。
- **交互模式** 🗣️: 核心命令（`create` 和 `apply`）支持无参调用，自动进入交互引导模式。
- **国际化支持** 🌐: 内置中英文语言支持
- **高性能** ⚡: 使用 Rust 语言开发，确保内存安全和运行时的高效率与可靠性。

## 使用说明

WimPatch 是一个命令行工具，提供以下子命令：

### 创建补丁 📦

创建增量补丁文件，用于将更新后的 WIM 文件应用到基础 WIM 文件。

> 💡 交互式模式 (Interactive Mode)
>
> 如果不提供任何参数，直接运行 `WimPatch.exe create`，程序将自动进入引导式交互模式，通过清晰的提示步骤帮助您完成所有必填参数的输入和校验。

```bash
WimPatch.exe create --base <基础WIM文件> --target <更新后的WIM文件> --out <输出补丁文件> --version <版本号> [选项]
```

- 必须指定 `--version`版本参数（遵循 [SemVer](https://semver.org/lang/zh-CN/) 规范），此参数来确定链式补丁的应用顺序。*
  *强烈建议每次生成新补丁时，递增版本号。**
- 路径中包含空格的文件，需要用双引号括起来。
- 未指定索引时，默认应用所有镜像。
- 补丁包中的**文件差异数据默认使用`Zstd`算法进行存储压缩**，以在压缩效率和速度之间取得最佳平衡。
- 当使用 `--storage bsdiff` 时，`--preset` 参数将被忽略，因为 BSDiff 存储类型不支持压缩算法。

**参数说明**:

| 参数               | 短参数  | 描述                                                                                                                                         | 默认值       |
|------------------|------|--------------------------------------------------------------------------------------------------------------------------------------------|-----------|
| `--base`         | `-b` | 基础 WIM 文件路径，指定用于创建增量补丁的基础 WIM 文件，通常是未更新的 WIM 文件。                                                                                           | 必需        |
| `--target`       | `-t` | 更新后的 WIM 文件路径，指定包含更新内容的 WIM 文件，用于与基础 WIM 文件进行比较，生成增量补丁。                                                                                    | 必需        |
| `--out`          | `-o` | 输出补丁文件路径，指定生成的增量补丁文件的存储位置。                                                                                                                 | 必需        |
| `--version`      | `-v` | 补丁文件版本，必须是有效的 [SemVer](https://semver.org/lang/zh-CN/) 格式（如 1.0.0）。                                                                        | 必需        |
| `--author`       | `-a` | 补丁文件作者，用于标识创建该补丁的用户或团队。                                                                                                                    | `unknown` |
| `--name`         | `-n` | 补丁文件名称，用于标识补丁文件，默认自动生成（格式：基础镜像文件名-patch-v版本号）。                                                                                             | 自动生成      |
| `--description`  | `-d` | 补丁文件描述，用于说明补丁的作用和影响。                                                                                                                       | 无         |
| `--index`        | `-i` | WIM 文件中的镜像索引（指定此参数时，会同时应用于基础和目标文件，此参数与单独指定基础/目标索引的参数互斥）。                                                                                   | -         |
| `--base-index`   | 无    | 基础 WIM 文件中的镜像索引（必须与`--target-index`同时指定，与`--index`互斥）。                                                                                     | -         |
| `--target-index` | 无    | 更新后的 WIM 文件中的镜像索引（必须与`--base-index`同时指定，与`--index`互斥）。                                                                                     | -         |
| `--compress`     | `-c` | 补丁WIM文件压缩算法: `None`, `Xpress`, `Lzx` 。                                                                                                     | `Lzx`     |
| `--storage`      | `-s` | 补丁文件的存储类型：<br>• **Full**：完整存储，速度快但文件大；<br>• **Zstd**：Zstd算法差异存储，平衡大小和速度；<br>• **Bsdiff**：Bsdiff算法差异存储，文件最小但速度慢。                            | `Zstd`    |
| `--preset`       | `-p` | 压缩预设级别：<br>• **Fast**：快速压缩，处理速度快但压缩率较低；<br>• **Medium**：中等压缩，平衡速度和压缩率；<br>• **Best**：最佳压缩，高压缩率但处理速度较慢；<br>• **Extreme**：极限压缩，最高压缩率但处理速度最慢。 | `Medium`  |
| `--exclude`      | `-e` | 从补丁文件中排除的文件路径，可多次指定参数。                                                                                                                     | 无         |

**示例**:

```bash
WimPatch.exe create -b "D:\base-v1.0.0.wim" -t "D:\base-v1.1.0.wim" -o "D:\base-patch-v1.1.0.wim" -v 1.1.0 -a "FirTech" -n "1.0.0(patch01)" -d "更新系统默认配置文件和壁纸资源。调整了休眠模式的默认计时器设置。"
```

### 应用补丁 🚀

应用补丁到基础 WIM 文件，生成更新后的 WIM 文件。

> 💡 交互式模式 (Interactive Mode)
>
> 如果不提供任何参数，直接运行 `WimPatch.exe apply`，程序将自动进入引导式交互模式，通过清晰的提示步骤帮助您完成所有必填参数的输入和校验。

```bash
WimPatch.exe apply --base <基础WIM文件> --patch <补丁文件> --target <目标WIM文件> [选项]
```

- 未指定索引时，默认应用所有镜像。

**参数说明**:

| 参数          | 短参数  | 描述                                             | 默认值 |
|-------------|------|------------------------------------------------|-----|
| `--base`    | `-b` | 原始WIM镜像文件路径                                    | 必需  |
| `--patch`   | `-p` | 补丁文件路径                                         | 必需  |
| `--target`  | `-t` | 应用补丁后的输出镜像路径                                   | 必需  |
| `--index`   | `-i` | 基础 WIM 文件中的目标镜像索引（仅对该索引应用补丁。若不指定，将尝试匹配补丁包内所有卷） | 匹配  |
| `--exclude` | `-e` | 从补丁文件中排除的文件路径 (可以指定多个)                         | 无   |
| `--force`   | `-f` | 强制应用补丁，跳过基础卷的内容校验。**警告：可能导致映像损坏。**             | 无   |

**示例**:

```bash
WimPatch.exe apply -b "D:\base-v1.0.0.wim" -p "D:\base-patch-v1.1.0.wim" -t "D:\target-v1.1.0.wim"
```

### 合并补丁 🧩

合并多个增量补丁文件为一个综合补丁文件。

```bash
WimPatch.exe merge <补丁文件1> <补丁文件2> ... --out <输出补丁文件>
```

**参数说明**:

| 参数      | 短参数  | 描述           | 默认值 |
|---------|------|--------------|-----|
| `--out` | `-o` | 输出合并后的补丁文件路径 | 必需  |

**示例**:

```bash
WimPatch.exe merge "D:\base-patch-v1.1.0.wim" "D:\base-patch-v1.2.0.wim" -o "D:\base-patch-v1.2.0-merge.wim"
```

### 查看补丁信息 ℹ️

显示补丁文件的详细信息。

- 显示补丁文件的版本、作者、名称、描述等信息
- 可选以 XML 格式输出详细信息

```bash
WimPatch.exe info <补丁文件> [选项]
```

**参数说明**:
| 参数 | 短参数 | 描述 | 默认值 |
|---------|------|--------------|-----|
| `--xml` | `-x` | 以XML格式输出补丁信息 | 无 |

**示例**:

```bash
WimPatch.exe info "D:\base-patch-v1.1.0.wim"
WimPatch.exe info "D:\base-patch-v1.1.0.wim" --xml
```

### 清理挂载点 🧹

清理无效的 WIM 挂载点。

```bash
WimPatch.exe clean
```

### 全局选项 ⚙️

| 参数              | 短参数 | 描述                                       | 默认值    |
|-----------------|-----|------------------------------------------|--------|
| `--buffer-size` | 无   | 指定缓冲区大小（单位：字节）                           | 65536  |
| `--debug`       | 无   | 调试模式，输出调试信息到控制台                          | 无      |
| `--language`    | 无   | 设置程序语言 (`En`, `zh-cn`, `zh-tw`, `ja-jp`) | 自动识别   |
| `--scratchdir`  | 无   | 指定临时目录路径，用于存储中间文件和挂载点                    | 系统临时目录 |

## 技术说明 🔍

### 补丁创建/应用工作原理 ⚙️

WimPatch 使用 Windows 映像 API (WIMGAPI) 来处理 WIM 文件。程序会自动从嵌入式资源中提取所需的 `wimgapi.dll` 文件。

#### 创建补丁 (Create) 流程：

1. **挂载基础镜像：** 挂载基础 WIM 文件中的指定镜像卷（只读）。
2. **挂载目标镜像：** 挂载更新后的 WIM 文件中的指定镜像卷（只读）。
3. **对比文件差异：** 遍历两个挂载点，对比文件内容、属性和元数据，并调用 Zstd/BSDiff 算法计算文件级的二进制差异（Delta）。
4. **生成补丁数据：** 将步骤 3 生成的所有差异数据和元信息压缩，写入到输出补丁文件 (`.wim`) 中。
5. **卸载清理：** 卸载并清理基础镜像和目标镜像的挂载点。

#### 应用补丁 (Apply) 流程：

1. **准备可写基线：** 将原始基础 WIM 文件中的目标镜像 **复制到临时目录**，并以**读写（ReadWrite）模式挂载**。
2. **挂载补丁：** 挂载待应用的补丁文件（只读）。
3. **应用差异：** 遍历补丁文件中的数据，将补丁差异数据应用到步骤 1 中挂载的可写基础镜像上。
4. **提交更改：** 将所有已应用的更改和文件差异**提交**（Commit）到挂载点对应的临时 WIM 文件中。
5. **卸载清理：** 卸载**基础镜像的临时副本**和**补丁文件的挂载点**。
6. **导出目标 WIM：** 将步骤 4 提交后的临时 WIM 文件（即已打好补丁的镜像）**导出**到用户指定的目标 WIM 文件位置。

### 依赖项 📚

WimPatch 使用多个 Rust 库来实现其功能：

- `clap`: 命令行参数解析
- `zstd`: Zstd 压缩算法实现
- `bsdiff`: BSDiff 差分算法实现
- `quick-xml`: XML 解析和生成
- `rust-i18n`: 国际化支持
- 其他依赖项可在 `Cargo.toml` 文件中查看

## 注意事项 ⚠️

1. ⚡ 操作 WIM 文件可能需要管理员权限
2. 💾 处理大型 WIM 文件时，建议确保有足够的磁盘空间和内存
3. 💡 命令行环境：请通过命令行（CMD/PowerShell）启动程序。从资源管理器直接双击运行时，程序将自动退出。

## 许可证 📝

[Apache License 2.0](LICENSE)
